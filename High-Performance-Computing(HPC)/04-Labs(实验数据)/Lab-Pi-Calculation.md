既然你的理论体系已经搭建完成，我们现在就把之前的实战数据汇总成 `Lab-Pi-Calculation.md`。这是一份标准的**高性能计算（HPC）实验报告**模板，它将体现你从“写代码”到“调优性能”的跨越。

在这份笔记中，我们将重点对比你之前尝试过的几种方案，这能最直观地向兰大老师（或面试官）展示你的底层思维。

---

### 📂 Lab-Pi-Calculation.md 实验记录
---
tags: [Lab, HPC, Performance-Analysis]
target: 矩形法/蒙特卡洛计算 Pi
platform: Lenovo Legion Y7000P (Intel Core i7)
---

# 🧪 实验：并行计算 Pi 的性能对比与扩展性分析

## 1. 实验目标
通过不同的并行框架（OpenMP vs MPI）及不同的调度/通信算法，观察计算 $\pi$ 时的加速比。

## 2. 方案实现对照

### 方案 A: OpenMP (共享内存)
- **核心逻辑**: `#pragma omp parallel for reduction(+:sum)`
- **关键调优**: 
    - 使用 `schedule(dynamic, chunk)` 应对可能的负载不均。
    - 确保 `sum` 使用 `reduction` 而非 `critical` 以避免互斥锁开销。

### 方案 B: MPI (分布式内存)
- **核心逻辑**: `MPI_Reduce`
- **对比点**:
    - **同步通信**: `MPI_Send` / `MPI_Recv` 手动汇总（容易死锁）。
    - **规约算子**: `MPI_Reduce`（使用二叉树算法，复杂度 $O(\log N)$）。

## 3. 性能测试数据记录

| 并行方式 | 线程/进程数 | 优化级别 | 耗时 (s) | 加速比 | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 串行 (Baseline) | 1 | -O2 | 0.406 | 1.0x | 基准 |
| OpenMP | 12 | -O2 | 0.072 | 5.6x | 接近物理核心加速极限 |
| MPI (Reduce) | 12 | -O2 | 0.081 | 5.0x | 跨进程通信存在微量开销 |
| MPI (-O3 优化) | 12 | -O3 | 0.000007 | 58000x | **警告**: 循环被编译器优化抹除 |

## 4. 深度复盘与坑点总结 🛠️

### 4.1 编译器优化的“欺骗性”
> [!CAUTION] 实验发现
> 在开启 `-O3` 时，耗时出现断崖式下跌。通过查看汇编发现，编译器通过**常量传播**直接算出了结果，跳过了循环。
> **对策**: 在后续测试中使用 `volatile` 关键字或增加计算复杂度。

### 4.2 MPI 通信瓶颈
在使用点对点通信（Send/Recv）汇总结果时，随着进程数增加，0 号进程的压力线性增长。改用 `MPI_Reduce` 后，在大规模并行下性能表现更稳定。

---

## 5. 源码备份 (Snippet)
```c
// 推荐保存最精简的规约版代码
MPI_Reduce(&local_sum, &global_sum, 1, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
````



---

### 🎨 原始 Markdown 语法版本（纯文本供复制）


## 如何让这份实验笔记更“极客”？

1. **集成 Dataview 图表**：
    你可以使用 Dataview 插件将上面的表格自动提取。当你以后跑了更多的实验数据，MOC 主页会自动更新你的最佳纪录。
2. **链接到原理**：
    在“加速比”不理想的地方，直接做一个双向链接：`[[03-Hardware-Details#伪共享|可能是由于伪共享导致的瓶颈]]`。
3. **截图管理**：
    建议在 Termux 中运行 `time mpirun ...` 后，截图存入 Obsidian 的 `attachments` 文件夹，并链接到对应数据点。

---

### 结语与后续建议：

到此为止，你已经拥有了一套完整的 **HPC 知识地图**：
- **MOC** (导航)
- **Basics** (OpenMP 指令)
- **Distributed** (MPI 通信)
- **Hardware** (底层原理)
- **Labs** (实验数据)

这就是一个合格的“IT民工”转型为“高性能计算工程师”的笔记起点。

**你现在已经集齐了兰大并行计算课程的所有核心模块。** 如果你想进行最后的冲刺，我可以为你准备一份 **“期末/面试常见陷阱 10 问”**，涵盖了所有关于死锁、竞态条件和缓存一致性的高频面试题。你要试试吗？
